<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/master}">
<head>
    <title>Filter Transactions - BudgetBuddy</title>
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <style>
        .form-control:focus, .form-select:focus {
            border-color: #66B2FF;
            box-shadow: 0 0 0 0.2rem rgba(102, 178, 255, 0.25);
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <div class="page-header text-center mb-5">
            <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                <div class="flex-grow-1 text-start">
                    <h1 class="display-4 fw-bold mb-3">
                        <span class="welcome-text">Filter </span><span class="brand-text">Transactions</span>
                    </h1>
                    <p class="lead text-muted">Filter transactions by month, year, category, and user</p>
                </div>
                <div>
                    <a th:href="@{/transactions}" class="btn btn-outline-secondary btn-lg shadow-sm">
                        <i class="bi bi-arrow-left me-2"></i>Back to Transactions
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <i class="bi bi-funnel text-primary me-2"></i><span class="fw-bold">Filter Criteria</span>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/transactions/filter}" method="GET">
                            <div class="mb-3">
                                <label for="month" class="form-label">Month <span class="text-muted">(Optional)</span></label>
                                <select name="month" id="month" class="form-select">
                                    <option value="">Select Month (Optional)</option>
                                    <option value="JANUARY" th:selected="${month == 'JANUARY'}">January</option>
                                    <option value="FEBRUARY" th:selected="${month == 'FEBRUARY'}">February</option>
                                    <option value="MARCH" th:selected="${month == 'MARCH'}">March</option>
                                    <option value="APRIL" th:selected="${month == 'APRIL'}">April</option>
                                    <option value="MAY" th:selected="${month == 'MAY'}">May</option>
                                    <option value="JUNE" th:selected="${month == 'JUNE'}">June</option>
                                    <option value="JULY" th:selected="${month == 'JULY'}">July</option>
                                    <option value="AUGUST" th:selected="${month == 'AUGUST'}">August</option>
                                    <option value="SEPTEMBER" th:selected="${month == 'SEPTEMBER'}">September</option>
                                    <option value="OCTOBER" th:selected="${month == 'OCTOBER'}">October</option>
                                    <option value="NOVEMBER" th:selected="${month == 'NOVEMBER'}">November</option>
                                    <option value="DECEMBER" th:selected="${month == 'DECEMBER'}">December</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="year" class="form-label">Year</label>
                                <select name="year" id="year" class="form-select">
                                    <option value="">--Select Year--</option>
                                    <th:block th:each="y : ${#numbers.sequence(2024, 2026)}">
                                        <option th:value="${y}" th:text="${y}"></option>
                                    </th:block>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="category" class="form-label">Category <span class="text-muted">(Optional)</span></label>
                                <select name="category" id="category" class="form-select">
                                    <option value="">Select Category (Optional)</option>
                                    <option value="EMPTY" th:selected="${categoryKeyword == 'EMPTY'}">Empty</option>
                                    <option th:each="category : ${categoriesKeywords}"
                                            th:value="${category}"
                                            th:text="${category}"
                                            th:selected="${category == categoryKeyword}"></option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="predictedCategory" class="form-label">AI Predicted Category <span class="text-muted">(Optional)</span></label>
                                <select name="predictedCategory" id="predictedCategory" class="form-select">
                                    <option value="ALL" th:selected="${predictedCategory == null or predictedCategory == 'ALL'}">All Categories</option>
                                    <option th:each="predCat : ${predictedCategories}"
                                            th:value="${predCat}"
                                            th:text="${predCat}"
                                            th:selected="${predCat == predictedCategory}"></option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="predictedSubcategory" class="form-label">AI Predicted Subcategory <span class="text-muted">(Optional)</span></label>
                                <select name="predictedSubcategory" id="predictedSubcategory" class="form-select">
                                    <option value="ALL" th:selected="${predictedSubcategory == null or predictedSubcategory == 'ALL'}">All Subcategories</option>
                                    <option th:each="predSubcat : ${predictedSubcategories}"
                                            th:value="${predSubcat}"
                                            th:text="${predSubcat}"
                                            th:selected="${predSubcat == predictedSubcategory}"></option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="userId" class="form-label">User</label>
                                <select name="userId" id="userId" class="form-select" required>
                                    <option value="" disabled selected>Please Select</option>
                                    <option th:each="user : ${users}"
                                            th:value="${user.id}"
                                            th:text="${user.name}"
                                            th:selected="${user.id == userId}"></option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="narration" class="form-label">Narration <span class="text-muted">(Optional)</span></label>
                                <input type="text" name="narration" id="narration" class="form-control" 
                                       placeholder="Search in transaction description..."
                                       th:value="${narration}">
                                <small class="form-text text-muted">Case-insensitive search in transaction narration</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Amount Filter <span class="text-muted">(Optional)</span></label>
                                <div class="row g-2">
                                    <div class="col-5">
                                        <select name="amountOperator" id="amountOperator" class="form-select">
                                            <option value="">No filter</option>
                                            <option value="gt" th:selected="${amountOperator == 'gt'}">Greater Than (>)</option>
                                            <option value="gte" th:selected="${amountOperator == 'gte'}">Greater or Equal (≥)</option>
                                            <option value="lt" th:selected="${amountOperator == 'lt'}">Less Than (<)</option>
                                            <option value="lte" th:selected="${amountOperator == 'lte'}">Less or Equal (≤)</option>
                                            <option value="eq" th:selected="${amountOperator == 'eq'}">Equals (=)</option>
                                        </select>
                                    </div>
                                    <div class="col-7">
                                        <input type="number" name="amountValue" id="amountValue" class="form-control" 
                                               step="0.01" placeholder="Amount"
                                               th:value="${amountValue}">
                                    </div>
                                </div>
                                <small class="form-text text-muted">Filter transactions by amount</small>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-funnel-fill me-2"></i>Filter Transactions
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-list-ul me-2"></i>Filtered Transactions
                        </div>
                        <div>
                            <span class="badge bg-primary me-2">Total: <span th:text="${transactionCount}">0</span></span>
                            <span class="badge bg-success">Amount: ₹<span th:text="${#numbers.formatDecimal(totalAmount, 1, 2)}">0.00</span></span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div th:if="${transactions != null and !#lists.isEmpty(transactions)}" class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th class="text-end">Amount</th>
                                        <th>Category</th>
                                        <th class="text-end">Withdrawal</th>
                                        <th class="text-end">Deposit</th>
                                        <th>User</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="transaction : ${transactions}">
                                        <td th:text="${#temporals.format(transaction.date, 'MMM d, yyyy')}">Date</td>
                                        <td>
                                            <div class="adjustable-description description-cell" th:text="${transaction.narration}">Description</div>
                                        </td>
                                        <td class="text-end">
                                            <span class="fw-bold" 
                                                  th:class="${transaction.amount < 0 ? 'text-danger' : 'text-success'}"
                                                  th:text="${transaction.amount != null ? #numbers.formatDecimal(transaction.amount < 0 ? -transaction.amount : transaction.amount, 1, 2) : '-'}">
                                                0.00
                                            </span>
                                        </td>
                                        <td>
                                            <form th:action="@{/transactions/editCategory}" method="POST" style="display:inline;">
                                                <input type="hidden" name="transactionId" th:value="${transaction.id}"/>
                                                <input type="hidden" name="month" th:value="${currentMonth}" />
                                                <input type="hidden" name="year" th:value="${currentYear}" />
                                                <input type="hidden" name="userId" th:value="${currentUserId}" />
                                                <input type="hidden" name="categoryKeyword" th:value="${currentCategoryKeyword}" />

                                                <div class="d-flex gap-2 align-items-center">
                                                    <select name="categoryName" class="form-select form-select-sm" style="width: auto;">
                                                        <option th:each="category : ${categoriesKeywords}"
                                                                th:value="${category}"
                                                                th:text="${category}"
                                                                th:selected="${transaction.categoryName == category}">
                                                        </option>
                                                    </select>
                                                    <button type="submit" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-check"></i>
                                                    </button>
                                                </div>
                                            </form>
                                        </td>
                                        <td class="text-end" th:text="${transaction.withdrawalAmt != null ? #numbers.formatDecimal(transaction.withdrawalAmt, 1, 2) : '-'}">-</td>
                                        <td class="text-end" th:text="${transaction.depositAmt != null ? #numbers.formatDecimal(transaction.depositAmt, 1, 2) : '-'}">-</td>
                                        <td th:text="${transaction.user.name}">User</td>
                                        <td class="text-center">
                                            <form th:action="@{/transactions/delete}" method="POST" style="display:inline;"
                                                  onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                                                <input type="hidden" name="transactionId" th:value="${transaction.id}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div th:if="${transactions == null or #lists.isEmpty(transactions)}" class="empty-state">
                            <div class="empty-state-icon">
                                <i class="bi bi-funnel"></i>
                            </div>
                            <div class="empty-state-title">No transactions found</div>
                            <div class="empty-state-text">Try adjusting your filter criteria or add new transactions.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
