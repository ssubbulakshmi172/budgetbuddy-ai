<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/master}">

<head>
    <title>Financial Insights - BudgetBuddy</title>
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Premium Pastel Palette */
            --bg-primary: #fafbfc;
            --bg-card: #ffffff;
            --bg-gradient-1: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-gradient-2: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --bg-gradient-3: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --bg-gradient-4: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);
            --bg-gradient-5: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            
            /* Calm Colors */
            --color-primary: #6366f1;
            --color-secondary: #8b5cf6;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            
            /* Pastel Variants */
            --pastel-blue: #e0e7ff;
            --pastel-purple: #f3e8ff;
            --pastel-pink: #fce7f3;
            --pastel-green: #d1fae5;
            --pastel-orange: #fed7aa;
            --pastel-yellow: #fef3c7;
            
            /* Text Colors */
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            
            /* Borders & Shadows */
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            
            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
        }
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-2xl) var(--spacing-lg);
        }
        
        /* Header */
        .dashboard-header {
            margin-bottom: var(--spacing-2xl);
        }
        
        .dashboard-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.02em;
        }
        
        .dashboard-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .refresh-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .detect-anomalies-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }
        
        .detect-anomalies-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        
        .detect-anomalies-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .detect-anomalies-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }
        
        .detect-anomalies-btn i {
            font-size: 1rem;
        }
        
        .refresh-btn:hover {
            background: var(--bg-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        
        /* Premium Card */
        .premium-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .premium-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--bg-gradient-1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .premium-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
            border-color: var(--color-primary);
        }
        
        .premium-card:hover::before {
            opacity: 1;
        }
        
        .card-header-modern {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-title-modern {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .card-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: var(--pastel-blue);
            color: var(--color-primary);
        }
        
        /* Savings Projection Card */
        .savings-hero-card {
            background: var(--bg-gradient-5);
            border: none;
            padding: var(--spacing-2xl);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .savings-hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .savings-hero-card::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
        }
        
        .savings-amount {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin: var(--spacing-md) 0;
        }
        
        .savings-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-xl);
        }
        
        .savings-stat {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: var(--spacing-md);
            border-radius: 0.75rem;
        }
        
        .savings-stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-bottom: var(--spacing-xs);
        }
        
        .savings-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        /* Money Leak Cards */
        .money-leak-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            align-items: stretch;
        }
        
        .money-leak-card-modern {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: var(--spacing-lg);
            position: relative;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .money-leak-card-modern:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .leak-rank-badge {
            position: absolute;
            top: -0.75rem;
            right: var(--spacing-md);
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: var(--shadow-md);
        }
        
        .rank-1 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; }
        .rank-2 { background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); color: #374151; }
        .rank-3 { background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%); color: #7c2d12; }
        
        .leak-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
            text-align: left;
        }
        
        .leak-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.5;
            text-align: left;
        }
        
        .leak-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-danger);
            margin-bottom: var(--spacing-xs);
            letter-spacing: -0.02em;
            text-align: left;
        }
        
        .leak-meta {
            display: flex;
            justify-content: space-between;
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Anomaly Table */
        .anomaly-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .anomaly-table thead th {
            background: var(--bg-primary);
            padding: var(--spacing-md);
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
        }
        
        .anomaly-table tbody tr {
            transition: background 0.2s ease;
        }
        
        .anomaly-table tbody tr:hover {
            background: var(--bg-primary);
        }
        
        .anomaly-table tbody td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }
        
        .anomaly-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .anomaly-badge.high {
            background: var(--pastel-pink);
            color: var(--color-danger);
        }
        
        .anomaly-badge.medium {
            background: var(--pastel-yellow);
            color: var(--color-warning);
        }
        
        /* Category Badge */
        .category-badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--pastel-blue);
            color: var(--color-primary);
        }
        
        /* Progress Bar */
        .progress-modern {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 1rem;
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }
        
        .progress-bar-modern {
            height: 100%;
            background: var(--bg-gradient-1);
            border-radius: 1rem;
            transition: width 0.6s ease;
        }
        
        /* Alert Cards */
        .alert-card-modern {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 3px solid;
            border-radius: 0.75rem;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: all 0.2s ease;
        }
        
        .alert-card-modern:hover {
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }
        
        .alert-low { border-left-color: var(--color-success); }
        .alert-medium { border-left-color: var(--color-warning); }
        .alert-high { border-left-color: var(--color-danger); }
        .alert-critical { border-left-color: #dc2626; }
        
        /* Empty State */
        .error-banner {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid var(--color-danger);
            border-radius: 0.75rem;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .error-banner i {
            font-size: 1.25rem;
            color: var(--color-danger);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            color: var(--pastel-green);
            margin-bottom: var(--spacing-md);
        }
        
        /* Sparkline Container */
        .sparkline-container {
            height: 40px;
            width: 100%;
            margin: var(--spacing-sm) 0;
        }
        
        /* Metric Card */
        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: var(--spacing-md);
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .metric-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: var(--spacing-xs) 0;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Section Grid */
        .section-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--spacing-lg);
            align-items: start;
        }
        
        .section-full { 
            grid-column: span 12; 
            display: flex;
            flex-direction: column;
        }
        .section-half { grid-column: span 6; }
        .section-third { grid-column: span 4; }
        .section-quarter { grid-column: span 3; }
        
        @media (max-width: 768px) {
            .section-half,
            .section-third,
            .section-quarter {
                grid-column: span 12;
            }
            
            .money-leak-grid {
                grid-template-columns: 1fr;
            }
            
            .savings-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Subtle Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .premium-card {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Regular Spending Cards */
        .spending-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            transition: all 0.2s ease;
        }
        
        .spending-item:hover {
            background: var(--bg-card);
            box-shadow: var(--shadow-sm);
        }
        
        .spending-amount {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Info Badge */
        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 0.375rem 0.75rem;
            background: var(--pastel-blue);
            color: var(--color-primary);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="dashboard-container">
            <!-- Error Banner -->
            <div th:if="${hasError}" class="error-banner">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>
                    <strong>Some data could not be loaded:</strong>
                    <div style="font-size: 0.875rem; margin-top: 0.25rem;" th:text="${errorMessage}">Error message</div>
                    <button onclick="window.location.reload()" style="margin-top: 0.5rem; padding: 0.375rem 0.75rem; background: var(--color-danger); color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                        <i class="bi bi-arrow-clockwise"></i> Retry
                    </button>
                </div>
            </div>
            
            <!-- Header -->
            <div class="dashboard-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                        <h1 class="dashboard-title">Financial Insights</h1>
                        <p class="dashboard-subtitle">AI-powered analysis of your spending patterns</p>
                    </div>
                    <button class="refresh-btn" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="section-grid">
            
            <!-- ============================================ -->
            <!-- SECTION 1: OVERVIEW & SUMMARY -->
            <!-- ============================================ -->
            <div class="section-full" style="margin-bottom: var(--spacing-xl);">
                <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 2px solid var(--border-color);">
                    <i class="bi bi-speedometer2" style="font-size: 1.25rem; color: var(--color-primary);"></i>
                    <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">Overview</h2>
                </div>
            </div>

            <!-- 1. Savings Projection Hero Card -->
            <div class="section-full" th:if="${savingsProjection != null}">
                <div class="premium-card savings-hero-card" style="position: relative; z-index: 1;">
                    <div style="position: relative; z-index: 2;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-lg);">
                            <div>
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: var(--spacing-xs);">Year-End Projection</div>
                                <div class="savings-amount">₹<span th:text="${#numbers.formatDecimal(savingsProjection.projectedYearEnd, 0, 0)}">0</span></div>
                                <div style="font-size: 0.875rem; opacity: 0.8; margin-top: var(--spacing-xs);">Includes income, expenses, and investments</div>
                            </div>
                            <div class="card-icon" style="background: rgba(255, 255, 255, 0.2); color: white;">
                                <i class="bi bi-piggy-bank"></i>
                            </div>
                        </div>
                        <div class="savings-stats-grid">
                            <div class="savings-stat">
                                <div class="savings-stat-label">Current Savings</div>
                                <div class="savings-stat-value">₹<span th:text="${#numbers.formatDecimal(savingsProjection.currentSavings, 0, 0)}">0</span></div>
                            </div>
                            <div class="savings-stat">
                                <div class="savings-stat-label">Monthly Rate</div>
                                <div class="savings-stat-value">₹<span th:text="${#numbers.formatDecimal(savingsProjection.monthlySavingsRate, 0, 0)}">0</span></div>
                                            </div>
                            <div class="savings-stat">
                                <div class="savings-stat-label">Remaining Months</div>
                                <div class="savings-stat-value" th:text="${savingsProjection.remainingMonths}">0</div>
                                        </div>
                            <div class="savings-stat">
                                <div class="savings-stat-label">Confidence</div>
                                <div class="savings-stat-value"><span th:text="${#numbers.formatDecimal(savingsProjection.confidenceScore * 100, 0, 0)}">0</span>%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- SECTION 2: ALERTS & ISSUES -->
            <!-- ============================================ -->
            <div class="section-full" style="margin-top: var(--spacing-2xl); margin-bottom: var(--spacing-xl);">
                <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 2px solid var(--border-color);">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 1.25rem; color: var(--color-danger);"></i>
                    <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">Alerts & Issues</h2>
                </div>
            </div>

            <!-- 2. Top Money Leaks -->
            <div class="section-full">
                <div class="premium-card">
                    <div class="card-header-modern">
                        <div class="card-title-modern">
                            <div class="card-icon" style="background: var(--pastel-pink); color: var(--color-danger);">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <span>Top Spending Areas</span>
                        </div>
                    </div>
                    <div th:if="${moneyLeaks == null or moneyLeaks.isEmpty()}" class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <p>No significant spending patterns detected. Great job!</p>
                    </div>
                    <div class="money-leak-grid" th:if="${moneyLeaks != null and !moneyLeaks.isEmpty()}">
                        <div class="money-leak-card-modern" th:each="leak : ${moneyLeaks}">
                            <span class="leak-rank-badge" 
                                  th:classappend="${leak.rank == 1} ? 'rank-1' : (${leak.rank == 2} ? 'rank-2' : 'rank-3')"
                                  th:text="${leak.rank != null ? leak.rank : '?'}">#</span>
                            <div class="leak-title" th:text="${leak.title != null ? leak.title : 'No Title'}">Title</div>
                            <div class="leak-description" th:text="${leak.description != null ? leak.description : 'No Description'}">Description</div>
                            <div class="leak-amount">₹<span th:text="${leak.monthlyAmount != null ? #numbers.formatDecimal(leak.monthlyAmount, 0, 0) : '0'}">0</span></div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--spacing-md); text-align: left;">per month</div>
                            <div class="leak-meta">
                                <span>₹<span th:text="${leak.annualAmount != null ? #numbers.formatDecimal(leak.annualAmount, 0, 0) : '0'}">0</span>/yr</span>
                                <span><span th:text="${leak.transactionCount != null ? leak.transactionCount : '0'}">0</span> transactions</span>
                            </div>
                            <div style="margin-top: auto; padding-top: var(--spacing-md); border-top: 1px solid var(--border-color);">
                                <!-- Use category filter if merchantPattern looks like a category (contains '/'), otherwise use narration -->
                                <a th:if="${leak.merchantPattern != null and !leak.merchantPattern.isEmpty()}"
                                   th:with="isCategory=${leak.merchantPattern != null and (leak.merchantPattern.contains('/') or leak.merchantPattern.contains('Friend') or leak.merchantPattern.contains('Group') or leak.merchantPattern.contains('&'))}"
                                   th:href="${isCategory} ? 
                                            @{/transactions/filter(predictedCategory=${leak.merchantPattern}, userId=${user.id})} : 
                                            @{/transactions/filter(narration=${leak.merchantPattern}, userId=${user.id})}" 
                                   class="btn btn-sm btn-outline-primary"
                                   style="font-size: 0.75rem; padding: 0.25rem 0.75rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem; width: 100%; justify-content: center;">
                                    <i class="bi bi-list-ul"></i> View Transactions
                                </a>
                                                </div>
                            <div style="margin-top: var(--spacing-sm); font-size: 0.75rem; color: var(--text-secondary); text-align: left; line-height: 1.4;" th:text="${leak.suggestion != null ? leak.suggestion : 'No suggestion'}">Suggestion</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

            <!-- 3. ML Anomaly Detection -->
            <div class="section-full">
                <div class="premium-card">
                    <div class="card-header-modern">
                        <div class="card-title-modern">
                            <div class="card-icon" style="background: var(--pastel-yellow); color: var(--color-warning);">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <span>Unusual Spending Patterns</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <span class="info-badge" style="background: var(--pastel-yellow); color: var(--color-warning); border: 1px solid var(--color-warning);">
                                <i class="bi bi-cpu"></i> ML-Powered
                            </span>
                            <button id="detectAnomaliesBtn" class="detect-anomalies-btn" 
                                    onclick="detectAnomalies()"
                                    style="background: linear-gradient(135deg, var(--color-warning) 0%, #f59e0b 100%); border: none; color: white; font-weight: 600; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">
                                <i class="bi bi-search"></i> Analyze Transactions
                            </button>
                        </div>
                    </div>
                    <div id="anomalyLoading" style="display: none; padding: var(--spacing-xl); text-align: center;">
                        <div class="spinner-border text-warning" role="status" style="width: 2rem; height: 2rem; border-width: 0.25rem; margin-bottom: var(--spacing-sm);">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Analyzing transactions...</p>
                    </div>
                    <div id="anomalyEmpty" class="empty-state" style="display: none; padding: var(--spacing-xl); text-align: center;">
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                            Click "Analyze Transactions" to detect unusual spending patterns.
                        </p>
                    </div>
                    <div id="anomalySuccess" class="empty-state" style="display: none; padding: var(--spacing-xl); text-align: center;">
                        <i class="bi bi-check-circle-fill" style="font-size: 2rem; color: var(--color-success); margin-bottom: var(--spacing-sm);"></i>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                            No unusual spending patterns detected.
                        </p>
                    </div>
                    <div id="anomalyTableContainer" style="display: none;">
                        <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm) var(--spacing-md); background: var(--pastel-yellow); border-radius: 0.5rem;">
                            <strong style="color: var(--color-warning);" id="anomalyCount">0</strong>
                            <span style="color: var(--text-secondary); font-size: 0.875rem; margin-left: 0.5rem;">unusual transactions detected</span>
                            <span id="anomalyLimitNote" style="color: var(--text-secondary); font-size: 0.75rem; margin-left: 0.5rem; font-style: italic; display: none;">(Showing top 5)</span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="anomalyTable" class="anomaly-table" style="display: table; width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="min-width: 100px;">Date</th>
                                        <th style="min-width: 120px;">Amount</th>
                                        <th style="min-width: 150px;">Category</th>
                                        <th style="min-width: 250px;">Description</th>
                                        <th style="min-width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="anomalyTableBody">
                                    <!-- Anomalies will be populated dynamically via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Category Overspending -->
            <div class="section-full">
                <div class="premium-card">
                    <div class="card-header-modern">
                        <div class="card-title-modern">
                            <div class="card-icon" style="background: var(--pastel-orange); color: var(--color-warning);">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <span>Category Overspending</span>
                        </div>
                    </div>
                    <div th:if="${categoryAlerts == null or categoryAlerts.isEmpty()}" class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <p>All categories are within normal spending limits</p>
                    </div>
                    <div th:if="${categoryAlerts != null and !categoryAlerts.isEmpty()}" th:each="alert : ${categoryAlerts}" 
                         class="alert-card-modern"
                         th:classappend="${alert.alertLevel.name() == 'CRITICAL'} ? 'alert-critical' : 
                                         (${alert.alertLevel.name() == 'HIGH'} ? 'alert-high' : 
                                         (${alert.alertLevel.name() == 'MEDIUM'} ? 'alert-medium' : 'alert-low'))">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                                    <h6 style="font-size: 1rem; font-weight: 600; margin: 0;" th:text="${alert.category}">Category</h6>
                                    <span class="category-badge" 
                                          th:classappend="${alert.alertLevel.name() == 'CRITICAL'} ? 'high' : 
                                                          (${alert.alertLevel.name() == 'HIGH'} ? 'medium' : '')"
                                          th:text="${alert.alertLevel}">MEDIUM</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: var(--spacing-xs);">Current Month</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary);">₹<span th:text="${#numbers.formatDecimal(alert.currentAmount, 0, 0)}">0</span></div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: var(--spacing-xs);">Historical Avg</div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-secondary);">₹<span th:text="${#numbers.formatDecimal(alert.historicalAvg, 0, 0)}">0</span></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: var(--spacing-sm);">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: var(--spacing-xs);">Increase</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--color-danger);">
                                        <span th:text="${#numbers.formatDecimal(alert.percentageIncrease, 1, 1)}">0</span>%
                                    </div>
                                </div>
                                <div class="progress-modern">
                                    <div class="progress-bar-modern" 
                                         th:style="'width: ' + ${alert.percentageIncrease > 200.0 ? 200.0 : alert.percentageIncrease} + '%'"
                                         style="background: var(--color-danger);"></div>
                            </div>
                                <div style="margin-top: var(--spacing-md);">
                                    <a th:href="@{/transactions/filter(predictedCategory=${alert.category}, userId=${user.id})}" 
                                       class="btn btn-sm btn-outline-primary"
                                       style="font-size: 0.75rem; padding: 0.25rem 0.75rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;">
                                        <i class="bi bi-list-ul"></i> View Transactions
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- SECTION 3: PATTERNS & TRENDS -->
            <!-- ============================================ -->
            <div class="section-full" style="margin-top: var(--spacing-2xl); margin-bottom: var(--spacing-xl);">
                <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 2px solid var(--border-color);">
                    <i class="bi bi-graph-up-arrow" style="font-size: 1.25rem; color: var(--color-info);"></i>
                    <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0;">Patterns & Trends</h2>
                </div>
            </div>

            <!-- 5. Weekend Spending -->
            <div class="section-full">
                <div>
                    <div class="premium-card">
                        <div class="card-header-modern">
                            <div class="card-title-modern">
                                <div class="card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <i class="bi bi-calendar-week"></i>
                                </div>
                                <div>
                                    <span>Weekend Spending</span>
                                    <div style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 400; margin-top: 0.1rem;">Excludes investments</div>
                        </div>
                            </div>
                        </div>
                        <div th:if="${weekendOverspending.isEmpty()}" class="empty-state" style="padding: var(--spacing-lg);">
                            <div class="empty-state-icon" style="color: #4caf50;">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-secondary);">No weekend overspending detected</p>
                        </div>
                        <div th:each="weekend : ${weekendOverspending}" style="margin-bottom: var(--spacing-md);">
                            <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 1px solid #e9ecef; border-radius: 12px; padding: var(--spacing-md); box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: transform 0.2s, box-shadow 0.2s;" 
                                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'"
                                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.04)'">
                                <!-- Header Row -->
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm);">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; font-size: 0.95rem; color: #2c3e50; margin-bottom: 0.2rem; line-height: 1.3;" th:text="${weekend.category}">Category</div>
                                        <div style="font-size: 0.7rem; color: #6c757d; display: flex; align-items: center; gap: 0.3rem;">
                                            <i class="bi bi-calendar3" style="font-size: 0.65rem;"></i>
                                            <span th:text="${weekend.month}">Month</span>
                                        </div>
                                    </div>
                                    <span th:switch="${weekend.alertLevel?.toString()}">
                                        <span th:case="'HIGH'" 
                                              style="font-size: 0.65rem; padding: 0.3rem 0.6rem; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border-radius: 20px; font-weight: 700; box-shadow: 0 2px 4px rgba(255,107,107,0.3);"
                                              th:text="${weekend.alertLevel}">HIGH</span>
                                        <span th:case="'MEDIUM'"
                                              style="font-size: 0.65rem; padding: 0.3rem 0.6rem; background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); color: white; border-radius: 20px; font-weight: 700; box-shadow: 0 2px 4px rgba(255,167,38,0.3);"
                                              th:text="${weekend.alertLevel}">MEDIUM</span>
                                        <span th:case="*"
                                              style="font-size: 0.65rem; padding: 0.3rem 0.6rem; background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); color: white; border-radius: 20px; font-weight: 700; box-shadow: 0 2px 4px rgba(66,165,245,0.3);"
                                              th:text="${weekend.alertLevel}">LOW</span>
                                    </span>
                                </div>
                                
                                <!-- Comparison Cards -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                                    <!-- Weekend Card -->
                                    <div style="background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%); border: 2px solid #ffcdd2; border-radius: 10px; padding: var(--spacing-sm); text-align: center;">
                                        <div style="font-size: 0.65rem; color: #c62828; font-weight: 600; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <i class="bi bi-calendar-week" style="margin-right: 0.2rem;"></i>Weekend
                                        </div>
                                        <div style="font-weight: 800; font-size: 1.3rem; color: #d32f2f; line-height: 1.2;">
                                            ₹<span th:text="${#numbers.formatDecimal(weekend.weekendAvg, 0, 0)}">0</span>
                                        </div>
                                        <div style="font-size: 0.6rem; color: #e57373; margin-top: 0.2rem;">
                                            Avg per transaction
                                        </div>
                                    </div>
                                    
                                    <!-- Weekday Card -->
                                    <div style="background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); border: 2px solid #bdbdbd; border-radius: 10px; padding: var(--spacing-sm); text-align: center;">
                                        <div style="font-size: 0.65rem; color: #616161; font-weight: 600; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <i class="bi bi-calendar-day" style="margin-right: 0.2rem;"></i>Weekday
                                        </div>
                                        <div style="font-weight: 800; font-size: 1.3rem; color: #424242; line-height: 1.2;">
                                            ₹<span th:text="${#numbers.formatDecimal(weekend.weekdayAvg, 0, 0)}">0</span>
                                        </div>
                                        <div style="font-size: 0.6rem; color: #757575; margin-top: 0.2rem;">
                                            Avg per transaction
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Impact Badge -->
                                <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 4px solid #d32f2f; border-radius: 8px; padding: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="bi bi-arrow-up-circle-fill" style="color: #d32f2f; font-size: 1.1rem;"></i>
                                            <div>
                                                <div style="font-size: 0.7rem; color: #c62828; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Spending Increase</div>
                                                <div style="font-size: 1rem; color: #d32f2f; font-weight: 800;">
                                                    <span th:text="${#numbers.formatDecimal(weekend.percentageIncrease, 1, 1)}">0"></span>%
                                                </div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 0.65rem; color: #c62828; font-weight: 600;">Total Weekend</div>
                                            <div style="font-size: 0.85rem; color: #d32f2f; font-weight: 700;">
                                                ₹<span th:text="${#numbers.formatDecimal(weekend.weekendSpending, 0, 0)}">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- View Transactions Button -->
                                <a th:attr="data-category=${weekend.category}, data-month=${weekend.month.monthValue}, data-year=${weekend.month.year}, data-user-id=${user.id}"
                                   th:onclick="'var category = this.getAttribute(\'data-category\') || \'\'; var month = this.getAttribute(\'data-month\') || \'\'; var year = this.getAttribute(\'data-year\') || \'\'; var userId = this.getAttribute(\'data-user-id\') || \'\'; window.location.href = \'/transactions/filter?predictedCategory=\' + encodeURIComponent(category) + \'&month=\' + month + \'&year=\' + year + \'&userId=\' + userId; return false;'"
                                   class="btn btn-sm"
                                   style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; font-size: 0.75rem; padding: 0.5rem 1rem; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-weight: 600; width: 100%; border-radius: 8px; box-shadow: 0 2px 6px rgba(102,126,234,0.3); transition: all 0.2s; cursor: pointer;"
                                   onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 10px rgba(102,126,234,0.4)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(102,126,234,0.3)'">
                                    <i class="bi bi-list-ul"></i> View Transactions
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. Regular Monthly Spending -->
            <div class="section-full" th:if="${!regularExpenses.isEmpty() or !regularInvestments.isEmpty()}">
                <div class="premium-card">
                    <div class="card-header-modern">
                        <div class="card-title-modern">
                            <div class="card-icon" style="background: var(--pastel-green); color: var(--color-success);">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                            <span>Regular Monthly Spending</span>
                        </div>
                    </div>
                    
                    <div th:if="${!regularExpenses.isEmpty()}" style="margin-bottom: var(--spacing-xl);">
                        <div style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            <i class="bi bi-cash-stack me-2"></i>Monthly Expenses
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-md);">
                            <div class="spending-item" th:each="expense : ${regularExpenses}">
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--spacing-xs);" th:text="${expense.title}">Monthly Expense</div>
                                <div class="spending-amount" style="color: var(--color-primary);">₹<span th:text="${#numbers.formatDecimal(expense.monthlyAmount, 0, 0)}">0</span></div>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: var(--spacing-xs); margin-bottom: var(--spacing-sm);">
                                    ₹<span th:text="${#numbers.formatDecimal(expense.annualAmount, 0, 0)}">0</span> annually
                                </div>
                                <div th:if="${expense.merchantPattern != null and !expense.merchantPattern.isEmpty()}">
                                    <a th:with="isCategory=${expense.merchantPattern != null and (expense.merchantPattern.contains('/') or expense.merchantPattern.contains('Friend') or expense.merchantPattern.contains('Group') or expense.merchantPattern.contains('&'))}"
                                       th:href="${isCategory} ? 
                                                @{/transactions/filter(predictedCategory=${expense.merchantPattern}, userId=${user.id})} : 
                                                @{/transactions/filter(narration=${expense.merchantPattern}, userId=${user.id})}" 
                                       class="btn btn-sm btn-outline-primary"
                                       style="font-size: 0.75rem; padding: 0.25rem 0.75rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;">
                                        <i class="bi bi-list-ul"></i> View Transactions
                                    </a>
                                </div>
                            </div>
                                            </div>
                                        </div>

                    <div th:if="${!regularInvestments.isEmpty()}">
                        <div style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            <i class="bi bi-graph-up-arrow me-2"></i>Monthly Investments
                                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-md);">
                            <div class="spending-item" th:each="investment : ${regularInvestments}">
                                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--spacing-xs);" th:text="${investment.title}">Monthly Investment</div>
                                <div class="spending-amount" style="color: var(--color-success);">₹<span th:text="${#numbers.formatDecimal(investment.monthlyAmount, 0, 0)}">0</span></div>
                                <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: var(--spacing-xs); margin-bottom: var(--spacing-sm);">
                                    ₹<span th:text="${#numbers.formatDecimal(investment.annualAmount, 0, 0)}">0</span> annually
                                        </div>
                                <div th:if="${investment.merchantPattern != null and !investment.merchantPattern.isEmpty()}">
                                    <a th:with="isCategory=${investment.merchantPattern != null and (investment.merchantPattern.contains('/') or investment.merchantPattern.contains('Friend') or investment.merchantPattern.contains('Group') or investment.merchantPattern.contains('&'))}"
                                       th:href="${isCategory} ? 
                                                @{/transactions/filter(predictedCategory=${investment.merchantPattern}, userId=${user.id})} : 
                                                @{/transactions/filter(narration=${investment.merchantPattern}, userId=${user.id})}" 
                                       class="btn btn-sm btn-outline-primary"
                                       style="font-size: 0.75rem; padding: 0.25rem 0.75rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;">
                                        <i class="bi bi-list-ul"></i> View Transactions
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            </div>
            
            <!-- Empty State - Show when no data is available -->
            <div th:if="${!hasError and (categoryAlerts == null or categoryAlerts.isEmpty()) and (moneyLeaks == null or moneyLeaks.isEmpty()) and (anomalies == null or anomalies.isEmpty()) and (regularExpenses == null or regularExpenses.isEmpty()) and (regularInvestments == null or regularInvestments.isEmpty()) and (weekendOverspending == null or weekendOverspending.isEmpty()) and savingsProjection == null}" 
                 class="section-full">
                <div class="premium-card" style="text-align: center; padding: var(--spacing-2xl);">
                    <div class="empty-state-icon" style="font-size: 4rem; color: var(--text-tertiary); margin-bottom: var(--spacing-lg);">
                        <i class="bi bi-inbox"></i>
                    </div>
                    <h3 style="color: var(--text-primary); margin-bottom: var(--spacing-sm);">No Financial Data Available</h3>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-lg);">
                        We need transaction data to generate insights. Please add some transactions first.
                    </p>
                    <a href="/transactions/new" style="display: inline-block; padding: 0.75rem 1.5rem; background: var(--color-primary); color: white; text-decoration: none; border-radius: 0.5rem; font-weight: 500;">
                        <i class="bi bi-plus-circle"></i> Add Transaction
                    </a>
        </div>
    </div>

            <!-- End Main Content Grid -->

            <!-- JavaScript for Async Anomaly Detection -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const userId = /*[[${user.id}]]*/ 1;
        const initialAnomalies = /*[[${anomalies}]]*/ [];
        
        // Auto-display anomalies on page load if they exist
        window.addEventListener('DOMContentLoaded', function() {
            if (initialAnomalies && initialAnomalies.length > 0) {
                displayAnomalies(initialAnomalies);
            } else {
                // Show empty state if no anomalies
                document.getElementById('anomalyEmpty').style.display = 'block';
            }
        });
        
        function displayAnomalies(data) {
            const loadingDiv = document.getElementById('anomalyLoading');
            const emptyDiv = document.getElementById('anomalyEmpty');
            const successDiv = document.getElementById('anomalySuccess');
            const tableContainer = document.getElementById('anomalyTableContainer');
            const table = document.getElementById('anomalyTable');
            const tableBody = document.getElementById('anomalyTableBody');
            const anomalyCount = document.getElementById('anomalyCount');
            
            loadingDiv.style.display = 'none';
            emptyDiv.style.display = 'none';
            
            if (data && data.length > 0) {
                // Show table with anomalies - limit to top 5
                tableBody.innerHTML = '';
                const limitedData = data.slice(0, 5); // Show only first 5 anomalies
                anomalyCount.textContent = data.length; // Show total count but display only limited
                
                // Show note if there are more than 5 anomalies
                const limitNote = document.getElementById('anomalyLimitNote');
                if (data.length > 5) {
                    limitNote.style.display = 'inline';
                } else {
                    limitNote.style.display = 'none';
                }
                
                limitedData.forEach(anomaly => {
                    const row = document.createElement('tr');
                    const amount = Math.abs(parseFloat(anomaly.amount || 0)).toLocaleString('en-IN', {maximumFractionDigits: 0});
                    const category = anomaly.category || 'Unknown';
                    const narration = anomaly.narration || '-';
                    const transactionId = anomaly.transaction_id || anomaly.id || null;
                    const narrationEncoded = encodeURIComponent(narration);
                    const categoryEncoded = encodeURIComponent(category);
                    
                    // Create link - use transaction ID if available, otherwise filter by narration and category
                    let viewLink = '';
                    if (transactionId) {
                        // Direct link to transaction edit/view page
                        viewLink = `/transactions/edit/${transactionId}`;
                    } else {
                        // Fallback to filter - use predictedCategory and userId
                        viewLink = `/transactions/filter?predictedCategory=${categoryEncoded}&userId=${userId}`;
                        if (narrationEncoded && narrationEncoded !== '-') {
                            viewLink += `&narration=${narrationEncoded}`;
                        }
                    }
                    
                    row.innerHTML = `
                        <td style="color: var(--text-secondary); font-size: 0.875rem;">${anomaly.date || '-'}</td>
                        <td><strong style="color: var(--color-danger); font-size: 1rem;">₹${amount}</strong></td>
                        <td><span class="category-badge" style="font-size: 0.75rem;">${category}</span></td>
                        <td style="color: var(--text-secondary); font-size: 0.875rem; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${narration}">${narration}</td>
                        <td>
                            <a href="${viewLink}" 
                               class="btn btn-sm btn-outline-primary"
                               style="font-size: 0.7rem; padding: 0.2rem 0.5rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.25rem;"
                               title="${transactionId ? 'View this transaction' : 'View similar transactions'}">
                                <i class="bi bi-eye"></i> View
                            </a>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                tableContainer.style.display = 'block';
                successDiv.style.display = 'none';
            } else {
                // Show success message (no anomalies)
                successDiv.style.display = 'block';
                tableContainer.style.display = 'none';
            }
        }
        
        function detectAnomalies() {
            const btn = document.getElementById('detectAnomaliesBtn');
            const loadingDiv = document.getElementById('anomalyLoading');
            const emptyDiv = document.getElementById('anomalyEmpty');
            const successDiv = document.getElementById('anomalySuccess');
            const table = document.getElementById('anomalyTable');
            const tableBody = document.getElementById('anomalyTableBody');
            
            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Detecting...';
            loadingDiv.style.display = 'block';
            emptyDiv.style.display = 'none';
            successDiv.style.display = 'none';
            table.style.display = 'none';
            
            // Make async request
            fetch('/guidance/anomalies/detect?userId=' + userId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cpu"></i> Detect Anomalies';
                displayAnomalies(data);
            })
            .catch(error => {
                console.error('Error detecting anomalies:', error);
                loadingDiv.style.display = 'none';
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cpu"></i> Detect Anomalies';
                emptyDiv.style.display = 'block';
                emptyDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: var(--color-warning); margin-bottom: var(--spacing-md);"></i>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                        Error detecting anomalies. Please try again.
                    </p>
                `;
            });
        }
        /*]]>*/
    </script>
</body>
</html>

