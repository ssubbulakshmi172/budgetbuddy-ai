<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/master}">

<head>
    <title>Dashboard (Manual Categories) - BudgetBuddy</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-hero {
            background: linear-gradient(135deg, var(--bb-primary) 0%, var(--bb-secondary) 100%);
            border-radius: var(--bb-radius-xl);
            padding: var(--bb-spacing-xl);
            color: white;
            margin-bottom: var(--bb-spacing-xl);
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .dashboard-hero > * {
            position: relative;
            z-index: 1;
        }
        
        .stat-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--bb-radius-lg);
            padding: var(--bb-spacing-xs) var(--bb-spacing-md);
            font-size: 0.875rem;
            font-weight: var(--bb-font-weight-medium);
        }
        
        .month-selector {
            display: flex;
            gap: var(--bb-spacing-sm);
            flex-wrap: wrap;
            margin-bottom: var(--bb-spacing-lg);
            padding: var(--bb-spacing-sm);
            background: var(--bb-gray-100);
            border-radius: var(--bb-radius-lg);
        }
        
        .month-btn {
            flex: 1;
            min-width: 90px;
            padding: var(--bb-spacing-sm) var(--bb-spacing-md);
            border: 2px solid transparent;
            background: white;
            border-radius: var(--bb-radius-md);
            font-size: 0.85rem;
            font-weight: var(--bb-font-weight-medium);
            color: var(--bb-gray-700);
            cursor: pointer;
            transition: var(--bb-transition-base);
            text-align: center;
        }
        
        .month-btn:hover {
            border-color: var(--bb-primary);
            color: var(--bb-primary);
            transform: translateY(-2px);
            box-shadow: var(--bb-shadow-sm);
        }
        
        .month-btn.active {
            background: var(--bb-primary);
            color: white;
            border-color: var(--bb-primary);
            box-shadow: var(--bb-shadow-md);
        }
        
        .chart-card {
            border: none;
            border-radius: var(--bb-radius-xl);
            box-shadow: var(--bb-shadow-lg);
            overflow: hidden;
            transition: var(--bb-transition-slow);
        }
        
        .chart-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--bb-shadow-xl);
        }
        
        .chart-header {
            background: linear-gradient(135deg, var(--bb-primary-light) 0%, white 100%);
            padding: var(--bb-spacing-lg);
            border-bottom: 2px solid var(--bb-gray-200);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--bb-spacing-lg);
            margin-bottom: var(--bb-spacing-xl);
        }
        
        .stat-card {
            background: white;
            border-radius: var(--bb-radius-lg);
            padding: var(--bb-spacing-lg);
            box-shadow: var(--bb-shadow-md);
            border-left: 4px solid var(--bb-primary);
            transition: var(--bb-transition-base);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--bb-shadow-lg);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--bb-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: var(--bb-spacing-md);
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: var(--bb-font-weight-bold);
            color: var(--bb-gray-900);
            margin-bottom: var(--bb-spacing-xs);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--bb-gray-600);
            font-weight: var(--bb-font-weight-medium);
        }
        
        .recent-transactions-card {
            border: none;
            border-radius: var(--bb-radius-xl);
            box-shadow: var(--bb-shadow-lg);
        }
        
        .transaction-item-modern {
            display: flex;
            align-items: center;
            padding: var(--bb-spacing-md);
            border-radius: var(--bb-radius-md);
            margin-bottom: var(--bb-spacing-sm);
            background: var(--bb-gray-50);
            border: 1px solid var(--bb-gray-200);
            transition: var(--bb-transition-base);
        }
        
        .transaction-item-modern:hover {
            background: white;
            border-color: var(--bb-primary);
            box-shadow: var(--bb-shadow-sm);
            transform: translateX(4px);
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                <div>
                    <h1 class="display-4 fw-bold mb-2">
                        <i class="bi bi-speedometer2 text-primary me-2"></i>Financial Dashboard
                    </h1>
                    <p class="lead text-muted mb-0">Track and analyze your spending patterns</p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <a th:href="@{/transactions/new}" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>Add Transaction
                    </a>
                    <a th:href="@{/transactions}" class="btn btn-outline-primary btn-lg">
                        <i class="bi bi-list-ul me-2"></i>View All
                    </a>
                </div>
            </div>
        </div>

        <!-- Info Banner for Manual Categories -->
        <div class="alert alert-info border-0 shadow-sm mb-4" role="alert" th:if="${usingManualCategories}">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>Manual Categories Dashboard</strong> - This view shows spending based on manually assigned categories (<code>categoryName</code> field). 
                    Visit <a th:href="@{/dashboard}" class="alert-link">/dashboard</a> for AI-predicted categories view.
                </div>
            </div>
        </div>
        
        <!-- Dashboard Hero Section -->
        <div class="dashboard-hero">
            
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <div>
                    <div class="stat-badge mb-1">
                        <i class="bi bi-calendar3 me-1"></i>
                        <span th:text="${hasCurrentMonthData ? currentMonth : lastMonth}">Current Month</span>
                    </div>
                    <h2 class="display-3 fw-bold mb-0" th:text="'₹' + ${#numbers.formatDecimal(totalSpending, 1, 2)}">₹0.00</h2>
                    <p class="mb-0 opacity-75" style="font-size: 0.9rem;">Total Spending</p>
                </div>
                <div class="vr" style="height: 60px; opacity: 0.3;"></div>
                <div>
                    <div class="stat-badge mb-1"
                         th:classappend="${percentageChange >= 0 ? 'bg-danger bg-opacity-25' : 'bg-success bg-opacity-25'}">
                        <i class="me-1" th:classappend="${percentageChange >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down'}"></i>
                        <span th:text="${#numbers.formatDecimal(T(java.lang.Math).abs(percentageChange), 1, 2)} + '%'"></span>
                    </div>
                    <p class="mb-0 opacity-75" style="font-size: 0.9rem;">vs Last Month</p>
                </div>
                <div class="vr" style="height: 60px; opacity: 0.3;"></div>
                <div>
                    <div class="stat-badge mb-1" th:if="${uncategorizedCount > 0}">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <span th:text="${uncategorizedCount}">0</span> Uncategorized
                    </div>
                    <p class="mb-0 opacity-75" style="font-size: 0.9rem;">Transactions</p>
                </div>
            </div>
        </div>

        <!-- Quick Stats Summary -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary mx-auto mb-3" style="width: 60px; height: 60px; font-size: 1.75rem;">
                            <i class="bi bi-cash-stack"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-1" th:text="'₹' + ${#numbers.formatDecimal(totalSpending, 1, 2)}">₹0.00</h3>
                        <p class="text-muted small mb-0">Total Spending</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success mx-auto mb-3" style="width: 60px; height: 60px; font-size: 1.75rem;">
                            <i class="bi bi-arrow-down-circle"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-1" 
                            th:style="${percentageChange < 0 ? 'color: var(--bb-success) !important;' : 'color: var(--bb-danger) !important;'}"
                            th:text="${percentageChange < 0 ? '-' : '+'} + ${#numbers.formatDecimal(T(java.lang.Math).abs(percentageChange), 1, 2)} + '%'">0%</h3>
                        <p class="text-muted small mb-0">Change from Last Month</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon bg-info bg-opacity-10 text-info mx-auto mb-3" style="width: 60px; height: 60px; font-size: 1.75rem;">
                            <i class="bi bi-tags"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-1" th:text="${categoryMonthComparison != null ? categoryMonthComparison.size() : 0}">0</h3>
                        <p class="text-muted small mb-0">Active Categories</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning mx-auto mb-3" style="width: 60px; height: 60px; font-size: 1.75rem;">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-1" th:text="${uncategorizedCount}">0</h3>
                        <p class="text-muted small mb-0">Uncategorized</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current vs Last Month Comparison -->
        <div class="card border-0 shadow-lg mb-4">
            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, var(--bb-primary) 0%, var(--bb-info) 100%); color: white; border: none;">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h4 class="fw-bold mb-1">
                            <i class="bi bi-graph-up-arrow me-2"></i>Month-over-Month Comparison
                        </h4>
                        <p class="mb-0 opacity-90" style="font-size: 0.9rem;">Track your spending trends</p>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    <!-- Current Month -->
                    <div class="col-md-6">
                        <div class="card h-100 border-2" style="border-color: var(--bb-primary) !important;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold mb-0">
                                        <i class="bi bi-calendar-check text-primary me-2"></i>
                                        <span th:text="${hasCurrentMonthData ? currentMonth : 'Last Month'}">Current Month</span>
                                    </h5>
                                    <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">Current</span>
                                </div>
                                <div class="display-5 fw-bold text-primary mb-2" 
                                     th:text="'₹' + ${#numbers.formatDecimal(currentMonthTotal, 1, 2)}">₹0.00</div>
                                <p class="text-muted mb-3">Total Expenses</p>
                                
                                <!-- Top Spending Categories -->
                                <div th:if="${!currentMonthSpendingByCategory.isEmpty()}">
                                    <h6 class="fw-semibold mb-3">Where Your Money Went:</h6>
                                    <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2 border-0"
                                     th:each="entry : ${currentMonthSpendingByCategorySorted}">
                                            <div class="d-flex align-items-center">
                                                <div class="me-2" style="width: 12px; height: 12px; border-radius: 50%; background: var(--bb-primary);"></div>
                                                <span class="fw-medium" th:text="${entry.key}">Category</span>
                                            </div>
                                            <span class="fw-bold" th:text="'₹' + ${#numbers.formatDecimal(entry.value, 1, 2)}">₹0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${currentMonthSpendingByCategory.isEmpty()}" class="text-center py-4">
                                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-0">No expenses this month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Last Month -->
                    <div class="col-md-6">
                        <div class="card h-100 border-2" style="border-color: var(--bb-gray-300) !important;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold mb-0">
                                        <i class="bi bi-calendar-x text-muted me-2"></i>
                                        <span th:text="${lastMonth}">Last Month</span>
                                    </h5>
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2">Previous</span>
                                </div>
                                <div class="display-5 fw-bold text-muted mb-2" 
                                     th:text="'₹' + ${#numbers.formatDecimal(lastMonthTotal, 1, 2)}">₹0.00</div>
                                <p class="text-muted mb-3">Total Expenses</p>
                                
                                <!-- Top Spending Categories -->
                                <div th:if="${!lastMonthSpendingByCategory.isEmpty()}">
                                    <h6 class="fw-semibold mb-3">Where Your Money Went:</h6>
                                    <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2 border-0"
                                     th:each="entry : ${lastMonthSpendingByCategorySorted}">
                                            <div class="d-flex align-items-center">
                                                <div class="me-2" style="width: 12px; height: 12px; border-radius: 50%; background: var(--bb-gray-400);"></div>
                                                <span class="fw-medium" th:text="${entry.key}">Category</span>
                                            </div>
                                            <span class="fw-bold" th:text="'₹' + ${#numbers.formatDecimal(entry.value, 1, 2)}">₹0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${lastMonthSpendingByCategory.isEmpty()}" class="text-center py-4">
                                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-0">No expenses last month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Summary -->
                <div class="row mt-4 pt-4 border-top">
                    <div class="col-12">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <div>
                                        <h6 class="fw-bold mb-2">Change from Last Month</h6>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge px-3 py-2"
                                                  th:classappend="${percentageChange >= 0 ? 'bg-danger' : 'bg-success'}"
                                                  th:text="${percentageChange >= 0 ? '↑ Increased' : '↓ Decreased'}">Change</span>
                                            <span class="fw-bold fs-5"
                                                  th:style="${percentageChange >= 0 ? 'color: var(--bb-danger) !important;' : 'color: var(--bb-success) !important;'}"
                                                  th:text="${percentageChange >= 0 ? '+' : ''} + ${#numbers.formatDecimal(percentageChange, 1, 2)} + '%'">0%</span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="text-muted small mb-1">Difference</div>
                                        <div class="fw-bold fs-5"
                                             th:style="${currentMonthTotal >= lastMonthTotal ? 'color: var(--bb-danger) !important;' : 'color: var(--bb-success) !important;'}"
                                             th:with="diff=${currentMonthTotal - lastMonthTotal}"
                                             th:text="${diff >= 0 ? '+' : ''} + '₹' + ${#numbers.formatDecimal(T(java.lang.Math).abs(diff), 1, 2)}">₹0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spending Breakdown by Category (Current Month) -->
        <div class="card border-0 shadow-lg mb-4" th:if="${!currentMonthSpendingByCategory.isEmpty()}">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h4 class="fw-bold mb-1">
                            <i class="bi bi-pie-chart-fill text-primary me-2"></i>Spending Breakdown
                        </h4>
                        <p class="text-muted small mb-0">Where your money is going this month</p>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-lg-8">
                        <div class="chart-container" style="position: relative; height: 350px;">
                            <canvas id="spendingBreakdownChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="spending-list">
                            <h6 class="fw-bold mb-3">By Category:</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2 border-bottom"
                                     th:each="entry : ${currentMonthSpendingByCategorySorted}">
                                    <div class="d-flex align-items-center">
                                        <div class="category-dot me-3" style="background: var(--bb-primary);"></div>
                                        <div>
                                            <div class="fw-semibold" th:text="${entry.key}">Category</div>
                                            <div class="text-muted small" 
                                                 th:with="percentage=${(entry.value / currentMonthTotal) * 100}"
                                                 th:text="${#numbers.formatDecimal(percentage, 1, 1)} + '%'">0%</div>
                                        </div>
                                    </div>
                                    <span class="fw-bold" th:text="'₹' + ${#numbers.formatDecimal(entry.value, 1, 2)}">₹0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Banners -->
        <div th:if="${uncategorizedCount > 0}" class="alert alert-warning border-0 shadow-sm mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>Action Required:</strong> You have 
                    <a th:href="@{/transactions}" class="alert-link fw-bold">
                        <span th:text="${uncategorizedCount}">0</span> uncategorized transactions
                    </a>. 
                    Categorize them now for better insights.
                </div>
            </div>
        </div>
        
        <div th:if="${!hasCurrentMonthData}" class="alert alert-info border-0 shadow-sm mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>No data for this month.</strong> Showing data from last month.
                </div>
            </div>
        </div>

        <!-- Category-wise Month Comparison -->
        <div class="card chart-card mb-4">
            <div class="chart-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                    <div>
                        <h4 class="fw-bold mb-1">
                            <i class="bi bi-bar-chart-fill text-primary me-2"></i>Category-wise Month Comparison (Manual Categories)
                        </h4>
                        <p class="text-muted small mb-0">6-Month Spending Trends by Manually Assigned Categories</p>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="viewBar" onclick="switchChartView('bar')">
                            <i class="bi bi-bar-chart me-1"></i>Bar
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="viewLine" onclick="switchChartView('line')">
                            <i class="bi bi-graph-up me-1"></i>Line
                        </button>
                        <button type="button" class="btn btn-sm btn-primary active" id="viewTable" onclick="switchChartView('table')">
                            <i class="bi bi-table me-1"></i>Table
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chart View -->
            <div class="card-body p-4" id="chartView" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" onclick="toggleView('grouped')" id="btnGrouped">
                            <i class="bi bi-bar-chart me-1"></i>Grouped
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="toggleView('stacked')" id="btnStacked">
                            <i class="bi bi-stack me-1"></i>Stacked
                        </button>
                    </div>
                    <div class="text-muted small">
                        <i class="bi bi-info-circle me-1"></i>Hover for details, click legend to toggle categories
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height: 500px;">
                    <canvas id="categoryMonthChart"></canvas>
                </div>
            </div>
            
            <!-- Table View -->
            <div class="card-body p-0" id="tableView">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover mb-0 align-middle" id="categoryMonthTable">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 100; background: white;">
                            <tr>
                                <th class="sticky-column" style="position: sticky; left: 0; background: white !important; z-index: 101; min-width: 150px;">
                                    <strong>Category</strong>
                                </th>
                                <th th:each="monthName : ${monthNames}" class="text-center" style="min-width: 120px;">
                                    <div class="fw-bold" th:text="${monthName}">Month</div>
                                </th>
                                <th class="text-center sticky-total" style="position: sticky; right: 60px; background: white !important; z-index: 101; min-width: 120px;">
                                    <strong>Total</strong>
                                </th>
                                <th class="text-center sticky-trend" style="position: sticky; right: 0; background: white !important; z-index: 101; min-width: 120px;">
                                    <strong>Trend</strong>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="categoryMonthTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                        <tfoot class="table-light" style="position: sticky; bottom: 0; z-index: 100; background: white;">
                            <tr>
                                <th class="sticky-column" style="position: sticky; left: 0; background: white !important; z-index: 101;">
                                    <strong>Total</strong>
                                </th>
                                <th th:each="monthKey : ${last6Months}" class="text-center" th:attr="id='monthTotal_' + ${monthKey}, data-month=${monthKey}">
                                    ₹0.00
                                </th>
                                <th class="text-center sticky-total" style="position: sticky; right: 60px; background: white !important; z-index: 101;" id="grandTotal">₹0.00</th>
                                <th class="text-center sticky-trend" style="position: sticky; right: 0; background: white !important; z-index: 101;">-</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="card-body p-4 text-center" th:if="${categoryMonthComparison.isEmpty()}">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-bar-chart"></i>
                    </div>
                    <div class="empty-state-title">No Spending Data</div>
                    <div class="empty-state-text">Start adding transactions to see your spending patterns</div>
                </div>
            </div>
        </div>


        <!-- Recent Transactions Card -->
        <div class="card recent-transactions-card">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1 fw-bold">Recent Transactions</h5>
                        <p class="text-muted small mb-0">Latest 5 transactions</p>
                    </div>
                    <a th:href="@{/transactions}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-right me-1"></i>View All
                    </a>
                </div>
            </div>
            <div class="card-body p-4">
                <div th:if="${!recentTransactions.isEmpty()}" class="transactions-list-modern">
                    <div class="transaction-item-modern" th:each="transaction : ${recentTransactions}">
                        <div class="me-3">
                            <div class="stat-icon"
                                 th:classappend="${transaction.categoryName != null and !transaction.categoryName.isEmpty() ? 'bg-primary text-white' : 'bg-secondary text-white'}"
                                 style="width: 40px; height: 40px; font-size: 1rem; margin: 0;">
                                <i th:classappend="${transaction.categoryName != null and !transaction.categoryName.isEmpty() ? 'bi bi-tag-fill' : 'bi bi-question-circle-fill'}"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold mb-1" 
                                 style="color: var(--bb-gray-900); font-size: 0.95rem;"
                                 th:text="${transaction.narration}">Transaction Description</div>
                            <div class="d-flex align-items-center gap-3">
                                <small class="text-muted" 
                                       th:text="${#temporals.format(transaction.date, 'MMM d, yyyy')}">Date</small>
                                <span class="badge badge-category" 
                                      th:classappend="${transaction.categoryName != null and !transaction.categoryName.isEmpty() ? 'badge-category' : 'badge-uncategorized'}"
                                      th:text="${transaction.categoryName ?: 'Uncategorized'}">Category</span>
                            </div>
                        </div>
                        <div class="ms-3 text-end">
                            <div class="fw-bold" 
                                 style="font-size: 1.1rem;"
                                 th:style="${transaction.amount < 0 ? 'color: var(--bb-danger) !important;' : 'color: var(--bb-success) !important;'}"
                                 th:with="absAmount=${transaction.amount < 0 ? -transaction.amount : transaction.amount}">
                                <span th:text="${transaction.amount < 0 ? '-' : '+'} + '₹' + ${#numbers.formatDecimal(absAmount, 1, 2)}">₹0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="empty-state" th:if="${recentTransactions.isEmpty()}">
                    <div class="empty-state-icon">
                        <i class="bi bi-inbox"></i>
                    </div>
                    <div class="empty-state-title">No Recent Transactions</div>
                    <div class="empty-state-text">Your recent transactions will appear here</div>
                    <a th:href="@{/transactions/new}" class="btn btn-primary mt-3">
                        <i class="bi bi-plus-lg me-2"></i>Add First Transaction
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Initialize category-wise 6-month comparison chart
        let categoryChart = null;
        let isStacked = false;
        let currentChartType = 'bar';
        let categoryMonthData = {};
        let monthNames = [];
        let monthKeys = [];
        let categories = [];
        
        // Switch between chart views (Bar, Line, Table)
        function switchChartView(viewType) {
            currentChartType = viewType;
            
            // Update button states
            document.querySelectorAll('#viewBar, #viewLine, #viewTable').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            const chartView = document.getElementById('chartView');
            const tableView = document.getElementById('tableView');
            
            if (viewType === 'table') {
                chartView.style.display = 'none';
                tableView.style.display = 'block';
                document.getElementById('viewTable').classList.add('active', 'btn-primary');
                document.getElementById('viewTable').classList.remove('btn-outline-primary');
                buildTableView();
            } else {
                chartView.style.display = 'block';
                tableView.style.display = 'none';
                if (viewType === 'bar') {
                    document.getElementById('viewBar').classList.add('active', 'btn-primary');
                    document.getElementById('viewBar').classList.remove('btn-outline-primary');
                    currentChartType = 'bar';
                } else {
                    document.getElementById('viewLine').classList.add('active', 'btn-primary');
                    document.getElementById('viewLine').classList.remove('btn-outline-primary');
                    currentChartType = 'line';
                }
                if (categoryChart) {
                    categoryChart.destroy();
                }
                initializeChart();
            }
        }
        
        // Build table view with trend indicators
        function buildTableView() {
            const tbody = document.getElementById('categoryMonthTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            const monthTotals = {};
            let grandTotal = 0;
            
            // Sort categories by total spending (descending)
            const sortedCategories = categories.map(cat => {
                const total = monthKeys.reduce((sum, key) => {
                    const val = (categoryMonthData[cat] && categoryMonthData[cat][key]) || 0;
                    return sum + val;
                }, 0);
                return { category: cat, total: total };
            }).sort((a, b) => b.total - a.total);
            
            sortedCategories.forEach(({category, total: catTotal}) => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                
                // Category name cell (sticky)
                const categoryCell = document.createElement('td');
                categoryCell.className = 'sticky-column';
                categoryCell.style.cssText = 'position: sticky; left: 0; background: white; z-index: 10; font-weight: 600; min-width: 150px;';
                categoryCell.textContent = category;
                row.appendChild(categoryCell);
                
                // Month data cells
                const values = [];
                monthKeys.forEach((monthKey, index) => {
                    const val = (categoryMonthData[category] && categoryMonthData[category][monthKey]) || 0;
                    values.push(val);
                    monthTotals[monthKey] = (monthTotals[monthKey] || 0) + val;
                    
                    const cell = document.createElement('td');
                    cell.className = 'text-center';
                    cell.style.minWidth = '120px';
                    if (val > 0) {
                        cell.innerHTML = `<strong>₹${val.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>`;
                        cell.style.color = 'var(--bb-gray-900)';
                    } else {
                        cell.innerHTML = '<span class="text-muted">-</span>';
                    }
                    row.appendChild(cell);
                });
                
                // Total cell (sticky)
                const totalCell = document.createElement('td');
                totalCell.className = 'text-center bg-light sticky-total';
                totalCell.style.cssText = 'position: sticky; right: 60px; background: white !important; z-index: 10; min-width: 120px;';
                totalCell.innerHTML = `<strong>₹${catTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>`;
                row.appendChild(totalCell);
                
                // Trend cell (sticky)
                const trendCell = document.createElement('td');
                trendCell.className = 'text-center bg-light sticky-trend';
                trendCell.style.cssText = 'position: sticky; right: 0; background: white !important; z-index: 10; min-width: 120px;';
                if (values.length >= 2) {
                    const first = values[0] || 0;
                    const last = values[values.length - 1] || 0;
                    const change = last - first;
                    const percentage = first > 0 ? ((change / first) * 100) : (last > 0 ? 100 : 0);
                    
                    if (Math.abs(change) < 0.01) {
                        trendCell.innerHTML = '<span class="badge bg-secondary">→ Stable</span>';
                    } else if (change > 0) {
                        trendCell.innerHTML = `<span class="badge bg-danger">↑ +${percentage.toFixed(1)}%</span>`;
                    } else {
                        trendCell.innerHTML = `<span class="badge bg-success">↓ ${percentage.toFixed(1)}%</span>`;
                    }
                } else {
                    trendCell.innerHTML = '<span class="text-muted">-</span>';
                }
                row.appendChild(trendCell);
                
                grandTotal += catTotal;
                tbody.appendChild(row);
            });
            
            // Update footer totals
            monthKeys.forEach((monthKey) => {
                const monthTotal = monthTotals[monthKey] || 0;
                const footerCell = document.getElementById(`monthTotal_${monthKey}`);
                if (footerCell) {
                    footerCell.textContent = `₹${monthTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
            });
            
            const grandTotalCell = document.getElementById('grandTotal');
            if (grandTotalCell) {
                grandTotalCell.textContent = `₹${grandTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
        }
        
        // Initialize chart
        function initializeChart() {
            const ctx = document.getElementById('categoryMonthChart');
            if (!ctx) return;
            
            const monthColors = [
                { bg: 'rgba(108, 117, 125, 0.6)', border: 'rgba(108, 117, 125, 1)' },
                { bg: 'rgba(108, 117, 125, 0.7)', border: 'rgba(108, 117, 125, 1)' },
                { bg: 'rgba(76, 201, 240, 0.6)', border: 'rgba(76, 201, 240, 1)' },
                { bg: 'rgba(76, 201, 240, 0.7)', border: 'rgba(76, 201, 240, 1)' },
                { bg: 'rgba(67, 97, 238, 0.7)', border: 'rgba(67, 97, 238, 1)' },
                { bg: 'rgba(67, 97, 238, 0.9)', border: 'rgba(67, 97, 238, 1)' }
            ];
            
            const datasets = monthKeys.map((monthKey, index) => {
                const data = categories.map(cat => 
                    (categoryMonthData[cat] && categoryMonthData[cat][monthKey]) || 0
                );
                
                return {
                    label: monthNames[index] || monthKey,
                    data: data,
                    backgroundColor: monthColors[index].bg,
                    borderColor: monthColors[index].border,
                    borderWidth: 2,
                    borderRadius: currentChartType === 'bar' ? 6 : 0,
                    borderSkipped: false,
                    fill: currentChartType === 'line' ? false : undefined,
                    tension: currentChartType === 'line' ? 0.4 : undefined
                };
            });
            
            if (categories.length > 0 && datasets.length > 0) {
                categoryChart = new Chart(ctx, {
                    type: currentChartType,
                    data: {
                        labels: categories,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                stacked: isStacked,
                                grid: {
                                    display: false,
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 11,
                                        weight: '600',
                                        family: 'var(--bb-font-family)'
                                    },
                                    maxRotation: currentChartType === 'bar' ? 45 : 0,
                                    minRotation: currentChartType === 'bar' ? 35 : 0,
                                    color: 'rgba(0, 0, 0, 0.75)',
                                    padding: 10
                                }
                            },
                            y: {
                                beginAtZero: true,
                                stacked: isStacked,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 100000) {
                                            return '₹' + (value / 100000).toFixed(1) + 'L';
                                        } else if (value >= 1000) {
                                            return '₹' + (value / 1000).toFixed(0) + 'K';
                                        }
                                        return '₹' + value.toFixed(0);
                                    },
                                    font: {
                                        size: 11,
                                        family: 'var(--bb-font-family)'
                                    },
                                    color: 'rgba(0, 0, 0, 0.75)',
                                    padding: 10
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'center',
                                labels: {
                                    padding: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 12,
                                    boxPadding: 5,
                                    font: {
                                        size: 12,
                                        weight: '600',
                                        family: 'var(--bb-font-family)'
                                    },
                                    color: 'rgba(0, 0, 0, 0.85)'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: 'rgba(0, 0, 0, 0.9)',
                                bodyColor: 'rgba(0, 0, 0, 0.8)',
                                borderColor: 'rgba(0, 0, 0, 0.1)',
                                borderWidth: 1,
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y || 0;
                                        return `${label}: ₹${value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            categoryMonthData = /*[[${categoryMonthComparison}]]*/ {};
            monthNames = /*[[${monthNames}]]*/ [];
            monthKeys = /*[[${last6Months}]]*/ [];
            categories = Object.keys(categoryMonthData).sort();
            
            // Start with table view by default
            if (categories.length > 0) {
                buildTableView();
            } else {
                // If no data, show chart view
                initializeChart();
            }
        });
        
        function toggleView(mode) {
            if (!categoryChart) return;
            
            isStacked = (mode === 'stacked');
            categoryChart.options.scales.x.stacked = isStacked;
            categoryChart.options.scales.y.stacked = isStacked;
            
            categoryChart.update();
            
            // Update button states
            document.querySelectorAll('#btnGrouped, #btnStacked').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-secondary');
            });
            
            const activeBtn = document.getElementById(mode === 'stacked' ? 'btnStacked' : 'btnGrouped');
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline-secondary');
                activeBtn.classList.add('btn-primary');
            }
        }
        
        // Spending Breakdown Pie Chart
        const spendingBreakdownData = /*[[${currentMonthSpendingByCategory}]]*/ {};
        const spendingBreakdownCtx = document.getElementById('spendingBreakdownChart');
        
        if (spendingBreakdownCtx && Object.keys(spendingBreakdownData).length > 0) {
            const sortedEntries = Object.entries(spendingBreakdownData)
                .sort((a, b) => b[1] - a[1]);
            
            const colors = [
                'rgba(67, 97, 238, 0.8)',   // Primary blue
                'rgba(28, 200, 138, 0.8)',   // Success green
                'rgba(246, 194, 62, 0.8)',   // Warning yellow
                'rgba(231, 74, 59, 0.8)',    // Danger red
                'rgba(54, 185, 204, 0.8)',   // Info cyan
                'rgba(114, 9, 183, 0.8)',    // Secondary purple
                'rgba(102, 126, 234, 0.8)',  // Accent purple
                'rgba(76, 201, 240, 0.8)',   // Light blue
                'rgba(118, 75, 162, 0.8)',   // Purple
                'rgba(17, 153, 142, 0.8)'    // Teal
            ];
            
            new Chart(spendingBreakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: sortedEntries.map(e => e[0]),
                    datasets: [{
                        data: sortedEntries.map(e => e[1]),
                        backgroundColor: colors.slice(0, sortedEntries.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ₹${value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
    
    <style>
        .category-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        /* Enhanced Table Styling */
        #categoryMonthTable {
            font-size: 0.95rem;
        }
        
        #categoryMonthTable tbody tr {
            transition: background-color 0.2s ease;
        }
        
        #categoryMonthTable tbody tr:hover {
            background-color: var(--bb-gray-50);
            cursor: pointer;
        }
        
        #categoryMonthTable tbody td {
            padding: 0.75rem;
            vertical-align: middle;
        }
        
        #categoryMonthTable thead th,
        #categoryMonthTable tfoot th {
            padding: 0.75rem;
            font-weight: 600;
            background-color: var(--bb-gray-100) !important;
        }
        
        .sticky-column {
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
        }
        
        .sticky-total,
        .sticky-trend {
            box-shadow: -2px 0 4px rgba(0, 0, 0, 0.05);
        }
        
        /* Table scrollbar styling */
        .table-responsive::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: var(--bb-gray-100);
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--bb-gray-400);
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: var(--bb-gray-500);
        }
        
        /* Trend badges */
        #categoryMonthTable .badge {
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            font-weight: 600;
        }
        
        /* Value highlighting */
        #categoryMonthTable tbody td strong {
            color: var(--bb-gray-900);
        }
        
        /* Month header styling */
        #categoryMonthTable thead th {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--bb-gray-700);
        }
    </style>
</div>
</body>
</html>
